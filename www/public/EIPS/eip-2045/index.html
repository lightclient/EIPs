<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https:&#x2F;&#x2F;eips.ethereum.com&#x2F;minima.css">

        <!-- opengraph -->
        <meta property="og:locale" content="en_US" />
        <meta property="og:url" content="https:&#x2F;&#x2F;eips.ethereum.com" />
        <meta property="og:site_name" content="Ethereum Improvement Proposals" />

        <!-- twitter -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@ethereum" />

        <script type="application/ld+json">
            {
              "@type": "WebSite",
              "url": "https:&#x2F;&#x2F;eips.ethereum.com",
              "name": "Ethereum Improvement Proposals",
              "description": "Description",
              "@context": "https://schema.org"
            }
        </script>

        

        

<title>EIP-2045: Particle gas costs for EVM opcodes</title>
<link rel="canonical" href="https:&#x2F;&#x2F;eips.ethereum.comEIPS&#x2F;eip-2045.md" />
<meta property="og:title" content="EIP-2045: Particle gas costs for EVM opcodes" />
<meta
    name="description"
    content="Details on Ethereum Improvement Proposal 2045 (EIP-2045): Particle gas costs for EVM opcodes"
/>
<meta
    property="og:description"
    content="Details on Ethereum Improvement Proposal 2045 (EIP-2045): Particle gas costs for EVM opcodes"
/>
<meta property="og:url" content="https:&#x2F;&#x2F;eips.ethereum.comEIPS&#x2F;eip-2045.md" />
<meta name="twitter:description" content="Details on Ethereum Improvement Proposal 2045 (EIP 2045): Particle gas costs for EVM opcodes" />

    </head>
    <body>
        <header class="site-header">
            <div class="wrapper">
                <a class="site-title" rel="author" href="https:&#x2F;&#x2F;eips.ethereum.com">Ethereum Improvement Proposals</a>
                <nav class="site-nav">
                    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
                    <label for="nav-trigger">
                        <span class="menu-icon">
                            <svg viewBox="0 0 18 15" width="18px" height="15px">
                                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
                            </svg>
                        </span>
                    </label>

                    <div class="trigger">
                        
                            <a class="page-link" href="&#x2F;all">All</a>
                        
                            <a class="page-link" href="&#x2F;core">Core</a>
                        
                            <a class="page-link" href="&#x2F;networking">Networking</a>
                        
                            <a class="page-link" href="&#x2F;interface">Interface</a>
                        
                            <a class="page-link" href="&#x2F;erc">ERC</a>
                        
                            <a class="page-link" href="&#x2F;meta">Meta</a>
                        
                            <a class="page-link" href="&#x2F;informational">Informational</a>
                        
                    </div>
                </nav>
            </div>
        </header>
        <main class="page-content" aria-label="Content">
            <div class="wrapper">
                
<div class="home">
    <h1 class="page-heading">
        EIP-2045: Particle gas costs for EVM opcodes
        <a href=""><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
    </h1>
    <table>
        <tr>
            <th>Author</th>
            <td>
    
        
        
            <a href="https://github.com/cdetrio">Casey Detrio</a>,
        
    
        
        
            <a href="https://github.com/axic"> Alex Beregszaszi</a>
        
    
</td>
        </tr>

        
          <tr>
              <th>Discussions-To</th>
              <td><a href="https:&#x2F;&#x2F;ethereum-magicians.org&#x2F;t&#x2F;eip-2045-fractional-gas-costs&#x2F;3311">https:&#x2F;&#x2F;ethereum-magicians.org&#x2F;t&#x2F;eip-2045-fractional-gas-costs&#x2F;3311</a></td>
          </tr>
        

        <tr>
            <th>Status</th>
            <td>
                Draft
                
            </td>
        </tr>

        <tr>
            <th>Type</th>
            <td>Standards Track</td>
        </tr>

        
          <tr>
              <th>Category</th>
              <td>Core</td>
          </tr>
        

        <tr>
            <th>Created</th>
            <td>2019-05-17</td>
        </tr>

        

        

        

        

        
  </table>

  
    <h2 id="abstract">Abstract</h2>
<p>According to recent benchmarks, EVM opcodes for computation (<code>ADD</code>, <code>SUB</code>, <code>MUL</code>, etc.) are generally overpriced relative to opcodes for storage I/O (<code>SLOAD</code>, <code>SSTORE</code>, etc.). Currently the minimum gas cost is 1 (i.e. one unit of gas), and most computational opcodes have a cost near to 1 (e.g. 3, 5, or 8), so the range in possible cost reduction is limited. A new minimum unit of gas, called a &quot;particle&quot;, which is a fraction of 1 gas, would expand the range of gas costs and thus enable reductions below the current minimum.</p>
<h2 id="motivation">Motivation</h2>
<p>The transaction capacity of an Ethereum block is determined by the gas cost of transactions relative to the block gas limit. One way to boost the transaction capacity is to raise the block gas limit. Unfortunately, raising the block gas limit would also increase the rate of state growth, unless the costs of state-expanding storage opcodes (<code>SSTORE</code>, <code>CREATE</code>, etc.) are simultaneously increased to the same proportion. Increasing the cost of storage opcodes may have adverse side effects, such as shifting the economic assumptions around gas fees of deployed contracts, or possibly breaking invariants in current contract executions (as mentioned in <a href="https://eips.ethereum.org/EIPS/eip-2035">EIP-2035</a><sup><a href="https://eips.ethereum.com/EIPS/eip-2045/#eip2035">1</a></sup>, more research is needed on the potential effects of increasing the cost of storage opcodes).</p>
<p>Another way to boost the transaction capacity of a block is to reduce the gas cost of transactions. Reducing the gas costs of computational opcodes while keeping the cost of storage opcodes the same, is effectively equivalent to raising the block gas limit and simultaneously increasing the cost of storage opcodes. However, reducing the cost of computational opcodes might avoid the adverse side effects of an increase in cost of storage opcodes (again, more research is needed on this topic).</p>
<p>Currently, computational opcode costs are already too close to the minimum unit of 1 gas to achieve the large degree of cost reductions that recent benchmarks<sup><a href="https://eips.ethereum.com/EIPS/eip-2045/#evmbenchmarks">2</a></sup> indicate would be needed to tune opcode gas costs to the performance of optimized EVM implementations. A smaller minimum unit called a &quot;particle&quot;, which is a fraction (or subdivision) of 1 gas, would enable large cost reductions.</p>
<h2 id="specification">Specification</h2>
<p>A new gas counter <code>particlesUsed</code> is added to the EVM, in addition to the existing gas counter <code>gasUsed</code>. The unit 1 gas is equal to 10000 particles (<code>PARTICLES_PER_GAS</code>). The <code>particlesUsed</code> counter is only increased for opcodes priced in particles (i.e. opcodes that cost less than 1 gas). If increasing <code>particlesUsed</code> results in an excess of 1 gas, then 1 gas is added to <code>gasUsed</code> (and deducted from <code>particlesUsed</code>).</p>
<p>Where the current gas logic looks like this:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">vm_execute</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ext</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">msg</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">code</span><span style="color:#c0c5ce;">):
    </span><span style="color:#65737e;"># Initialize stack, memory, program counter, etc
    </span><span style="color:#c0c5ce;">compustate = </span><span style="color:#bf616a;">Compustate</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">gas</span><span style="color:#c0c5ce;">=msg.gas)
    codelen = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(code)

    </span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">compustate.pc &lt; codelen:
        opcode = code[compustate.pc]
        compustate.pc += </span><span style="color:#d08770;">1

        </span><span style="color:#c0c5ce;">compustate.gasUsed += opcode.gas_fee

        </span><span style="color:#65737e;"># out of gas error
        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">compustate.gasUsed &gt; compustate.gasLimit:
            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">vm_exception</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">OUT OF GAS</span><span style="color:#c0c5ce;">&#39;)

        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">STOP</span><span style="color:#c0c5ce;">&#39;:
            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">peaceful_exit</span><span style="color:#c0c5ce;">()
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">ADD</span><span style="color:#c0c5ce;">&#39;:
            stk.</span><span style="color:#bf616a;">append</span><span style="color:#c0c5ce;">(stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">() + stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">())
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">SUB</span><span style="color:#c0c5ce;">&#39;:
            stk.</span><span style="color:#bf616a;">append</span><span style="color:#c0c5ce;">(stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">() - stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">())
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">MUL</span><span style="color:#c0c5ce;">&#39;:
            stk.</span><span style="color:#bf616a;">append</span><span style="color:#c0c5ce;">(stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">() * stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">())

.....
</span></code></pre>
<p>The new gas logic using particles might look like this:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#bf616a;">PARTICLES_PER_GAS </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">10000

</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">vm_execute</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ext</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">msg</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">code</span><span style="color:#c0c5ce;">):
    </span><span style="color:#65737e;"># Initialize stack, memory, program counter, etc
    </span><span style="color:#c0c5ce;">compustate = </span><span style="color:#bf616a;">Compustate</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">gas</span><span style="color:#c0c5ce;">=msg.gas)
    codelen = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(code)

    </span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">compustate.pc &lt; codelen:
        opcode = code[compustate.pc]
        compustate.pc += </span><span style="color:#d08770;">1

        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">opcode.gas_fee:
            compustate.gasUsed += opcode.gas_fee
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">opcode.particle_fee:
            compustate.particlesUsed += opcode.particle_fee
            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">compustate.particlesUsed &gt;= </span><span style="color:#bf616a;">PARTICLES_PER_GAS</span><span style="color:#c0c5ce;">:
                </span><span style="color:#65737e;"># particlesUsed will be between 1 and 2 gas (over 10000 but under 20000)
                </span><span style="color:#c0c5ce;">compustate.gasUsed += </span><span style="color:#d08770;">1
                </span><span style="color:#65737e;"># remainder stays in particle counter
                </span><span style="color:#c0c5ce;">compustate.particlesUsed = compustate.particlesUsed % </span><span style="color:#bf616a;">PARTICLES_PER_GAS

        </span><span style="color:#65737e;"># out of gas error
        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">compustate.gasUsed &gt; compustate.gasLimit:
            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">vm_exception</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">OUT OF GAS</span><span style="color:#c0c5ce;">&#39;)

        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">STOP</span><span style="color:#c0c5ce;">&#39;:
            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">peaceful_exit</span><span style="color:#c0c5ce;">()
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">ADD</span><span style="color:#c0c5ce;">&#39;:
            stk.</span><span style="color:#bf616a;">append</span><span style="color:#c0c5ce;">(stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">() + stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">())
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">SUB</span><span style="color:#c0c5ce;">&#39;:
            stk.</span><span style="color:#bf616a;">append</span><span style="color:#c0c5ce;">(stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">() - stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">())
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">op == &#39;</span><span style="color:#a3be8c;">MUL</span><span style="color:#c0c5ce;">&#39;:
            stk.</span><span style="color:#bf616a;">append</span><span style="color:#c0c5ce;">(stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">() * stk.</span><span style="color:#bf616a;">pop</span><span style="color:#c0c5ce;">())

.....
</span></code></pre>
<p>The above pseudocode is written for clarity. A more performant implementation might instead keep a single <code>particlesUsed</code> counter by multiplying opcode gas costs by 10000 and the <code>gasLimit</code> by 10000, and convert particles back to gas with <code>ceil(particlesUsed / PARTICLES_PER_GAS)</code> at the end of execution. It may also be more performant to use a <code>PARTICLES_PER_GAS</code> ratio that is a power of 2 (such as 8192 or 16384) instead of 10000; the spec above is a draft and updates in response to feedback are expected.</p>
<h4 id="opcode-cost-changes">Opcode cost changes</h4>
<p>Many computational opcodes will undergo a cost reduction, with new costs suggested by benchmark analyses. For example, the cost of <code>DUP</code> and <code>SWAP</code> are reduced from 3 gas to 3000 particles (i.e. 0.3 gas). The cost of <code>ADD</code> and <code>SUB</code> are reduced from 3 gas to 6000 particles. The cost of <code>MUL</code> is reduced from 5 gas to 5000 particles (i.e. 0.5 gas).</p>
<h2 id="rationale">Rationale</h2>
<p>Adoption of fractional gas costs should only be an implementation detail inside the EVM, and not alter the current user experience around transaction gas limits and block gas limits. The concept of <code>particles</code> need not be exposed to Ethereum users nor most contract authors, but only to EVM implementers and contract developers concerned with optimized gas usage. Furthermore, only the EVM logic for charging gas per opcode executed should be affected by this change. All other contexts dealing with gas and gas limits, such as block headers and transaction formats, should be unaffected.</p>
<h3 id="ewasm">Ewasm</h3>
<p>The term &quot;particles&quot; was first introduced for Ewasm<sup><a href="https://eips.ethereum.com/EIPS/eip-2045/#particle">3</a></sup> to enable gas accounting for low cost wasm instructions, while remaining compatible with EVM gas costs. This EIP proposes introducing particles as a new minimum gas unit for EVM opcodes, and is not related to Ewasm.</p>
<h2 id="backwards-compatibility">Backwards Compatibility</h2>
<p>This change is not backwards compatible and requires a hard fork to be activated.</p>
<h2 id="test-cases">Test Cases</h2>
<p>TODO</p>
<h2 id="implementation">Implementation</h2>
<p>TODO</p>
<h2 id="references">References</h2>
<p><a name="eip2035">1</a>. <a href="https://eips.ethereum.org/EIPS/eip-2035">EIP-2035</a>: Stateless Clients - Repricing SLOAD and SSTORE to pay for block proofs</p>
<p><a name="evmbenchmarks">2</a>. https://github.com/ewasm/benchmarking</p>
<p><a name="particle">3</a>. The term &quot;particle&quot; was inspired by a proposal for <a href="https://github.com/ewasm/design/blob/e77d8e3de42784f40a803a23f58ef06881142d9f/determining_wasm_gas_costs.md">Ewasm gas costs</a>.</p>
<h2 id="copyright">Copyright</h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>



            </div>
        </main>


        <footer class="site-footer h-card">
            <div class="wrapper">
                <h2 class="footer-heading">Ethereum Improvement Proposals</h2>
                <div class="footer-col-wrapper">
                    <div class="footer-col footer-col-1">
                        <ul class="contact-list">
                            <li class="p-name">
                                
                                GitHub User
                                
                            </li>
                            <li>
                                <a class="u-email" href="mailto:your-email@domain.com">
                                  your-email@domain.com
                                </a>
                              </li>
                            </ul>
                    </div>
                    <div class="footer-col footer-col-3">
                        <p>Description</p>
                    </div>
                </div>
            </div>
        </footer>
    </body>
</html>
