<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https:&#x2F;&#x2F;eips.ethereum.com&#x2F;minima.css">

        <!-- opengraph -->
        <meta property="og:locale" content="en_US" />
        <meta property="og:url" content="https:&#x2F;&#x2F;eips.ethereum.com" />
        <meta property="og:site_name" content="Ethereum Improvement Proposals" />

        <!-- twitter -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@ethereum" />

        <script type="application/ld+json">
            {
              "@type": "WebSite",
              "url": "https:&#x2F;&#x2F;eips.ethereum.com",
              "name": "Ethereum Improvement Proposals",
              "description": "Description",
              "@context": "https://schema.org"
            }
        </script>

        

        

<title>EIP-107: safe &amp;quot;eth_sendTransaction&amp;quot; authorization via html popup</title>
<link rel="canonical" href="https:&#x2F;&#x2F;eips.ethereum.comEIPS&#x2F;eip-107.md" />
<meta property="og:title" content="EIP-107: safe &amp;quot;eth_sendTransaction&amp;quot; authorization via html popup" />
<meta
    name="description"
    content="Details on Ethereum Improvement Proposal 107 (EIP-107): safe &amp;quot;eth_sendTransaction&amp;quot; authorization via html popup"
/>
<meta
    property="og:description"
    content="Details on Ethereum Improvement Proposal 107 (EIP-107): safe &amp;quot;eth_sendTransaction&amp;quot; authorization via html popup"
/>
<meta property="og:url" content="https:&#x2F;&#x2F;eips.ethereum.comEIPS&#x2F;eip-107.md" />
<meta name="twitter:description" content="Details on Ethereum Improvement Proposal 107 (EIP 107): safe &amp;quot;eth_sendTransaction&amp;quot; authorization via html popup" />

    </head>
    <body>
        <header class="site-header">
            <div class="wrapper">
                <a class="site-title" rel="author" href="https:&#x2F;&#x2F;eips.ethereum.com">Ethereum Improvement Proposals</a>
                <nav class="site-nav">
                    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
                    <label for="nav-trigger">
                        <span class="menu-icon">
                            <svg viewBox="0 0 18 15" width="18px" height="15px">
                                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
                            </svg>
                        </span>
                    </label>

                    <div class="trigger">
                        
                            <a class="page-link" href="&#x2F;all">All</a>
                        
                            <a class="page-link" href="&#x2F;core">Core</a>
                        
                            <a class="page-link" href="&#x2F;networking">Networking</a>
                        
                            <a class="page-link" href="&#x2F;interface">Interface</a>
                        
                            <a class="page-link" href="&#x2F;erc">ERC</a>
                        
                            <a class="page-link" href="&#x2F;meta">Meta</a>
                        
                            <a class="page-link" href="&#x2F;informational">Informational</a>
                        
                    </div>
                </nav>
            </div>
        </header>
        <main class="page-content" aria-label="Content">
            <div class="wrapper">
                
<div class="home">
    <h1 class="page-heading">
        EIP-107: safe &quot;eth_sendTransaction&quot; authorization via html popup
        <a href=""><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
    </h1>
    <table>
        <tr>
            <th>Author</th>
            <td>
    
        
        
            <a href="https://github.com/wighawag">Ronan Sandford</a>
        
    
</td>
        </tr>

        

        <tr>
            <th>Status</th>
            <td>
                Draft
                
            </td>
        </tr>

        <tr>
            <th>Type</th>
            <td>Standards Track</td>
        </tr>

        
          <tr>
              <th>Category</th>
              <td>Interface</td>
          </tr>
        

        <tr>
            <th>Created</th>
            <td>2016-06-05</td>
        </tr>

        

        

        

        

        
  </table>

  
    <h1 id="abstract">Abstract</h1>
<p>This draft EIP describes the details of an authorization method that if provided by rpc enabled ethereum nodes would allow regular websites to send transactions (via <code>eth_sendTransaction</code>) without the need to enable CORS. Instead, user would be asked to confirm the transaction via an html popup.</p>
<p>Every read only rpc call the dapp wants to perform is redirected to an invisible iframe from the node's domain and for every transaction that the dapp wish to execute, an html popup is presented to the user to allow him/her to cancel or confirm the transaction. This allows the dapp to connect to the node's rpc api without being  granted any kind of privileges. This allows users to safely interact with dapps running in their everyday web browser while their accounts are unlocked. In case the account is not unlocked, and the node has allowed the &quot;personal&quot; api via rpc,the html page also allow the user to enter their password to unlock the account for the scope of the transaction.</p>
<h1 id="motivation">Motivation</h1>
<p>Currently, if a user navigates to a dapp running on a website using her/his everyday browser, the dapp will by default have no access to the rpc api for security reasons. The user will have to enable CORS for the website's domain in order for the dapp to work. Unfortunately if the user does so, the dapp will be able to send transactions from any unlocked account without the need for any user consent. In other words, not only does the user need to change the node's default setting, but the user is also forced to trust the dapp in order to use it. This is of course not acceptable and forces existing dapps to rely on the use of workarounds like:</p>
<ul>
<li>if the transaction is a plain ether transfer, the user is asked to enter it in a dedicated trusted wallet like &quot;Mist&quot;</li>
<li>For more complex case, the user is asked to enter the transaction manually via the node command line interface.</li>
</ul>
<p>This proposal aims to provide a safe and user friendly alternative.</p>
<p>Here are some screenshots of the provided implementation of that html popup:</p>
<h2 id="account-unlocked">Account unlocked :</h2>
<p>When the account is already unlocked, the user is presented with the following popup for every transaction that the dapp attempts to make:</p>
<p><img src="../assets/eip-107/authorization.png" alt="" /></p>
<h2 id="account-locked-and-no-personal-api-exposed-via-rpc">Account locked and no &quot;personal&quot; api exposed via rpc:</h2>
<p>When the account is locked, and the node does not provide access to account unlocking via its rpc interface, the following popup will be presented. This is not ideal since this requires the user to know how to unlock an account:</p>
<p><img src="../assets/eip-107/authorization-locked.png" alt="" /></p>
<h2 id="account-locked-but-node-exposing-the-personal-api-via-rpc">Account locked but node exposing the &quot;personal&quot; api via rpc :</h2>
<p>A better option is to ask the user for their password, but this is only possible if the node allows access to the &quot;personal&quot; api via rpc. In such case, the following dialog will be presented to the user so he/she can accept the transaction by providing the password required to unlock the account:</p>
<p><img src="../assets/eip-107/authorization-password.png" alt="" /></p>
<h1 id="specification">Specification</h1>
<p>In order for the mechanism to work, the node needs to serve an html file via http at the url &lt;node url&gt;/authorization.html</p>
<p>This file will then be used by the dapp in 2 different modes (invisible iframe and popup window).</p>
<p>The invisible iframe will be embedded in the dapp to allow the dapp to send its read-only rpc call without having to enable CORS for the dapp's website domain. This is done by sending message to the iframe (via javascript <code>window.postMessage</code>) which in turn execute the rpc call. This works since the iframe and the node share the same domain/port.</p>
<p>In the iframe mode, the html file's javascript code will ensure that no call requiring an unlocked key can be made. This is to prevent dapps from embedding the invisible iframe and tricking the user into clicking the confirm button.
If the dapp requires an <code>eth_sendTransaction</code> call, the dapp will instead open a new window using the same url.</p>
<p>In this popup window mode, the html file's javascript code will allow <code>eth_sendTransaction</code> (but not  <code>eth_sign</code>, as there is no way to display to the user the meaningful content of the transaction to sign in a safe way) to be called. But instead of sending the call to the node directly, a confirmation dialog will be presented showing the sender and recipient addresses, as well as the amount being transferred along with the potential gas cost. Upon the user approving, the request will be sent and the result returned to the dapp. An error will be returned in case the user cancel the request.</p>
<p>The html page also checks for the availability of the &quot;personal&quot; api and if so, will ask the user to unlock the account if necessary. The unlocking is temporary (3s) so the password will be asked again if a transaction is attempted before the end of this short time.</p>
<p>In both iframe mode and window mode, the communication with the dapp is achieved using <code>window.postMessage</code>.
The fist message the iframe/window sends is a message containing the string &quot;ready&quot; to let the dapp know that it now accepts messages. Then the dapp can start performing rpc call by sending message using the following object :</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">{
  id:&lt;a an id&gt;, //so responses can be match as there is no guarantee of the order of the response
  payload:&lt;json rpc object&gt; //this is the exact object that usually send to the node
}
</span></code></pre>
<p>For <code>eth_sendTransaction</code> the &quot;gas&quot;, &quot;gasPrice&quot; and &quot;from&quot; field need to be set in the rpc parameter so that the window can display the correct value. If not all of these are passed in, the window will return an error.</p>
<p>Upon receiving such message, the iframe will perform the actual rpc call to the node but only if such a call is a read only call (not requiring an unlocked key). If it is not it will return a error. The window on the other will only accept <code>eth_sendTransaction</code> calls but will display a dialog so the user can accept or cancel the request.</p>
<p>In all the cases, the iframe/window will send a message back to the dapp using the following object:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">{
  id:&lt;id matching the request&gt;,
  result:&lt;rpc result as is&gt;,
  error:&lt;error object&gt;
}
</span></code></pre>
<p>the error object cannot be a javascript Error object due to postMessage limitation. Instead it is</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">{
  message:&lt;a string describing the error&gt;,
  type:&lt;a string defining the type of error&gt; //type=&quot;cancel&quot; means the user cancel the transaction
}
</span></code></pre><h1 id="rationale">Rationale</h1>
<p>The design for that proposal was chosen for its simplicity and security. A previous idea was to use an oauth-like protocol in order for the user to accept or deny a transaction request. It would have required deeper code change in the node and some geth contributors argues that such change did not fit into geth code base as it would have required dapp aware code.
The current design, instead has a very simple implementation (self contained html file that can be shared across node's implementation) and its safeness is guarantess by browsers' cross domain policies.</p>
<p>The use of iframe/ window was required to have both security and user friendliness. The invisible iframe allows the dapp to execute read only calls without the need for user input, and the window ensures user approval before making a call. While we could have made it without the window mode by making the iframe confirmation use the native browser <code>window.confirm</code> dialog, this would have prevented the use of a more elegant confirmation popup that the current design allows. It also happens to be that the <code>window.confirm</code> is not safe in some browsers, as it gives focus to the accept option and can be triggered automatically (https://bugs.chromium.org/p/chromium/issues/detail?id=260653).</p>
<h1 id="implementations">Implementations</h1>
<p>In order to implement this design, the following html file or an equivalent one needs to be served at the url &lt;node url&gt;/authorization.html</p>
<p>That's it.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Ethereum Authorization&lt;/title&gt;
  &lt;/head&gt;
  &lt;script&gt;
    //https://github.com/alexvandesande/blockies
    !function(){function r(r){for(var t=0;t&lt;l.length;t++)l[t]=0;for(var t=0;t&lt;r.length;t++)l[t%4]=(l[t%4]&lt;&lt;5)-l[t%4]+r.charCodeAt(t)}function t(){var r=l[0]^l[0]&lt;&lt;11;return l[0]=l[1],l[1]=l[2],l[2]=l[3],l[3]=l[3]^l[3]&gt;&gt;19^r^r&gt;&gt;8,(l[3]&gt;&gt;&gt;0)/(1&lt;&lt;31&gt;&gt;&gt;0)}function e(){var r=Math.floor(360*t()),e=60*t()+40+&quot;%&quot;,o=25*(t()+t()+t()+t())+&quot;%&quot;,n=&quot;hsl(&quot;+r+&quot;,&quot;+e+&quot;,&quot;+o+&quot;)&quot;;return n}function o(r){for(var e=r,o=r,n=Math.ceil(e/2),a=e-n,l=[],c=0;o&gt;c;c++){for(var f=[],h=0;n&gt;h;h++)f[h]=Math.floor(2.3*t());var i=f.slice(0,a);i.reverse(),f=f.concat(i);for(var v=0;v&lt;f.length;v++)l.push(f[v])}return l}function n(r,t,e,o,n){var a=document.createElement(&quot;canvas&quot;),l=Math.sqrt(r.length);a.width=a.height=l*e;var c=a.getContext(&quot;2d&quot;);c.fillStyle=o,c.fillRect(0,0,a.width,a.height),c.fillStyle=t;for(var f=0;f&lt;r.length;f++){var h=Math.floor(f/l),i=f%l;c.fillStyle=1==r[f]?t:n,r[f]&amp;&amp;c.fillRect(i*e,h*e,e,e)}return a}function a(t){t=t||{};var a=t.size||8,l=t.scale||4,c=t.seed||Math.floor(Math.random()*Math.pow(10,16)).toString(16);r(c);var f=t.color||e(),h=t.bgcolor||e(),i=t.spotcolor||e(),v=o(a),u=n(v,f,l,h,i);return u}var l=new Array(4);window.blockies={create:a}}();

    /* bignumber.js v2.3.0 https://github.com/MikeMcl/bignumber.js/LICENCE */
    !function(e){&quot;use strict&quot;;function n(e){function E(e,n){var t,r,i,o,u,s,f=this;if(!(f instanceof E))return j&amp;&amp;L(26,&quot;constructor call without new&quot;,e),new E(e,n);if(null!=n&amp;&amp;H(n,2,64,M,&quot;base&quot;)){if(n=0|n,s=e+&quot;&quot;,10==n)return f=new E(e instanceof E?e:s),U(f,P+f.e+1,k);if((o=&quot;number&quot;==typeof e)&amp;&amp;0*e!=0||!new RegExp(&quot;^-?&quot;+(t=&quot;[&quot;+N.slice(0,n)+&quot;]+&quot;)+&quot;(?:\\.&quot;+t+&quot;)?$&quot;,37&gt;n?&quot;i&quot;:&quot;&quot;).test(s))return h(f,s,o,n);o?(f.s=0&gt;1/e?(s=s.slice(1),-1):1,j&amp;&amp;s.replace(/^0\.0*|\./,&quot;&quot;).length&gt;15&amp;&amp;L(M,v,e),o=!1):f.s=45===s.charCodeAt(0)?(s=s.slice(1),-1):1,s=D(s,10,n,f.s)}else{if(e instanceof E)return f.s=e.s,f.e=e.e,f.c=(e=e.c)?e.slice():e,void(M=0);if((o=&quot;number&quot;==typeof e)&amp;&amp;0*e==0){if(f.s=0&gt;1/e?(e=-e,-1):1,e===~~e){for(r=0,i=e;i&gt;=10;i/=10,r++);return f.e=r,f.c=[e],void(M=0)}s=e+&quot;&quot;}else{if(!g.test(s=e+&quot;&quot;))return h(f,s,o);f.s=45===s.charCodeAt(0)?(s=s.slice(1),-1):1}}for((r=s.indexOf(&quot;.&quot;))&gt;-1&amp;&amp;(s=s.replace(&quot;.&quot;,&quot;&quot;)),(i=s.search(/e/i))&gt;0?(0&gt;r&amp;&amp;(r=i),r+=+s.slice(i+1),s=s.substring(0,i)):0&gt;r&amp;&amp;(r=s.length),i=0;48===s.charCodeAt(i);i++);for(u=s.length;48===s.charCodeAt(--u););if(s=s.slice(i,u+1))if(u=s.length,o&amp;&amp;j&amp;&amp;u&gt;15&amp;&amp;(e&gt;y||e!==d(e))&amp;&amp;L(M,v,f.s*e),r=r-i-1,r&gt;z)f.c=f.e=null;else if(G&gt;r)f.c=[f.e=0];else{if(f.e=r,f.c=[],i=(r+1)%O,0&gt;r&amp;&amp;(i+=O),u&gt;i){for(i&amp;&amp;f.c.push(+s.slice(0,i)),u-=O;u&gt;i;)f.c.push(+s.slice(i,i+=O));s=s.slice(i),i=O-s.length}else i-=u;for(;i--;s+=&quot;0&quot;);f.c.push(+s)}else f.c=[f.e=0];M=0}function D(e,n,t,i){var o,u,f,c,a,h,g,p=e.indexOf(&quot;.&quot;),d=P,m=k;for(37&gt;t&amp;&amp;(e=e.toLowerCase()),p&gt;=0&amp;&amp;(f=J,J=0,e=e.replace(&quot;.&quot;,&quot;&quot;),g=new E(t),a=g.pow(e.length-p),J=f,g.c=s(l(r(a.c),a.e),10,n),g.e=g.c.length),h=s(e,t,n),u=f=h.length;0==h[--f];h.pop());if(!h[0])return&quot;0&quot;;if(0&gt;p?--u:(a.c=h,a.e=u,a.s=i,a=C(a,g,d,m,n),h=a.c,c=a.r,u=a.e),o=u+d+1,p=h[o],f=n/2,c=c||0&gt;o||null!=h[o+1],c=4&gt;m?(null!=p||c)&amp;&amp;(0==m||m==(a.s&lt;0?3:2)):p&gt;f||p==f&amp;&amp;(4==m||c||6==m&amp;&amp;1&amp;h[o-1]||m==(a.s&lt;0?8:7)),1&gt;o||!h[0])e=c?l(&quot;1&quot;,-d):&quot;0&quot;;else{if(h.length=o,c)for(--n;++h[--o]&gt;n;)h[o]=0,o||(++u,h.unshift(1));for(f=h.length;!h[--f];);for(p=0,e=&quot;&quot;;f&gt;=p;e+=N.charAt(h[p++]));e=l(e,u)}return e}function F(e,n,t,i){var o,u,s,c,a;if(t=null!=t&amp;&amp;H(t,0,8,i,w)?0|t:k,!e.c)return e.toString();if(o=e.c[0],s=e.e,null==n)a=r(e.c),a=19==i||24==i&amp;&amp;B&gt;=s?f(a,s):l(a,s);else if(e=U(new E(e),n,t),u=e.e,a=r(e.c),c=a.length,19==i||24==i&amp;&amp;(u&gt;=n||B&gt;=u)){for(;n&gt;c;a+=&quot;0&quot;,c++);a=f(a,u)}else if(n-=s,a=l(a,u),u+1&gt;c){if(--n&gt;0)for(a+=&quot;.&quot;;n--;a+=&quot;0&quot;);}else if(n+=u-c,n&gt;0)for(u+1==c&amp;&amp;(a+=&quot;.&quot;);n--;a+=&quot;0&quot;);return e.s&lt;0&amp;&amp;o?&quot;-&quot;+a:a}function _(e,n){var t,r,i=0;for(u(e[0])&amp;&amp;(e=e[0]),t=new E(e[0]);++i&lt;e.length;){if(r=new E(e[i]),!r.s){t=r;break}n.call(t,r)&amp;&amp;(t=r)}return t}function x(e,n,t,r,i){return(n&gt;e||e&gt;t||e!=c(e))&amp;&amp;L(r,(i||&quot;decimal places&quot;)+(n&gt;e||e&gt;t?&quot; out of range&quot;:&quot; not an integer&quot;),e),!0}function I(e,n,t){for(var r=1,i=n.length;!n[--i];n.pop());for(i=n[0];i&gt;=10;i/=10,r++);return(t=r+t*O-1)&gt;z?e.c=e.e=null:G&gt;t?e.c=[e.e=0]:(e.e=t,e.c=n),e}function L(e,n,t){var r=new Error([&quot;new BigNumber&quot;,&quot;cmp&quot;,&quot;config&quot;,&quot;div&quot;,&quot;divToInt&quot;,&quot;eq&quot;,&quot;gt&quot;,&quot;gte&quot;,&quot;lt&quot;,&quot;lte&quot;,&quot;minus&quot;,&quot;mod&quot;,&quot;plus&quot;,&quot;precision&quot;,&quot;random&quot;,&quot;round&quot;,&quot;shift&quot;,&quot;times&quot;,&quot;toDigits&quot;,&quot;toExponential&quot;,&quot;toFixed&quot;,&quot;toFormat&quot;,&quot;toFraction&quot;,&quot;pow&quot;,&quot;toPrecision&quot;,&quot;toString&quot;,&quot;BigNumber&quot;][e]+&quot;() &quot;+n+&quot;: &quot;+t);throw r.name=&quot;BigNumber Error&quot;,M=0,r}function U(e,n,t,r){var i,o,u,s,f,l,c,a=e.c,h=S;if(a){e:{for(i=1,s=a[0];s&gt;=10;s/=10,i++);if(o=n-i,0&gt;o)o+=O,u=n,f=a[l=0],c=f/h[i-u-1]%10|0;else if(l=p((o+1)/O),l&gt;=a.length){if(!r)break e;for(;a.length&lt;=l;a.push(0));f=c=0,i=1,o%=O,u=o-O+1}else{for(f=s=a[l],i=1;s&gt;=10;s/=10,i++);o%=O,u=o-O+i,c=0&gt;u?0:f/h[i-u-1]%10|0}if(r=r||0&gt;n||null!=a[l+1]||(0&gt;u?f:f%h[i-u-1]),r=4&gt;t?(c||r)&amp;&amp;(0==t||t==(e.s&lt;0?3:2)):c&gt;5||5==c&amp;&amp;(4==t||r||6==t&amp;&amp;(o&gt;0?u&gt;0?f/h[i-u]:0:a[l-1])%10&amp;1||t==(e.s&lt;0?8:7)),1&gt;n||!a[0])return a.length=0,r?(n-=e.e+1,a[0]=h[(O-n%O)%O],e.e=-n||0):a[0]=e.e=0,e;if(0==o?(a.length=l,s=1,l--):(a.length=l+1,s=h[O-o],a[l]=u&gt;0?d(f/h[i-u]%h[u])*s:0),r)for(;;){if(0==l){for(o=1,u=a[0];u&gt;=10;u/=10,o++);for(u=a[0]+=s,s=1;u&gt;=10;u/=10,s++);o!=s&amp;&amp;(e.e++,a[0]==b&amp;&amp;(a[0]=1));break}if(a[l]+=s,a[l]!=b)break;a[l--]=0,s=1}for(o=a.length;0===a[--o];a.pop());}e.e&gt;z?e.c=e.e=null:e.e&lt;G&amp;&amp;(e.c=[e.e=0])}return e}var C,M=0,T=E.prototype,q=new E(1),P=20,k=4,B=-7,$=21,G=-1e7,z=1e7,j=!0,H=x,V=!1,W=1,J=100,X={decimalSeparator:&quot;.&quot;,groupSeparator:&quot;,&quot;,groupSize:3,secondaryGroupSize:0,fractionGroupSeparator:&quot; &quot;,fractionGroupSize:0};return E.another=n,E.ROUND_UP=0,E.ROUND_DOWN=1,E.ROUND_CEIL=2,E.ROUND_FLOOR=3,E.ROUND_HALF_UP=4,E.ROUND_HALF_DOWN=5,E.ROUND_HALF_EVEN=6,E.ROUND_HALF_CEIL=7,E.ROUND_HALF_FLOOR=8,E.EUCLID=9,E.config=function(){var e,n,t=0,r={},i=arguments,s=i[0],f=s&amp;&amp;&quot;object&quot;==typeof s?function(){return s.hasOwnProperty(n)?null!=(e=s[n]):void 0}:function(){return i.length&gt;t?null!=(e=i[t++]):void 0};return f(n=&quot;DECIMAL_PLACES&quot;)&amp;&amp;H(e,0,A,2,n)&amp;&amp;(P=0|e),r[n]=P,f(n=&quot;ROUNDING_MODE&quot;)&amp;&amp;H(e,0,8,2,n)&amp;&amp;(k=0|e),r[n]=k,f(n=&quot;EXPONENTIAL_AT&quot;)&amp;&amp;(u(e)?H(e[0],-A,0,2,n)&amp;&amp;H(e[1],0,A,2,n)&amp;&amp;(B=0|e[0],$=0|e[1]):H(e,-A,A,2,n)&amp;&amp;(B=-($=0|(0&gt;e?-e:e)))),r[n]=[B,$],f(n=&quot;RANGE&quot;)&amp;&amp;(u(e)?H(e[0],-A,-1,2,n)&amp;&amp;H(e[1],1,A,2,n)&amp;&amp;(G=0|e[0],z=0|e[1]):H(e,-A,A,2,n)&amp;&amp;(0|e?G=-(z=0|(0&gt;e?-e:e)):j&amp;&amp;L(2,n+&quot; cannot be zero&quot;,e))),r[n]=[G,z],f(n=&quot;ERRORS&quot;)&amp;&amp;(e===!!e||1===e||0===e?(M=0,H=(j=!!e)?x:o):j&amp;&amp;L(2,n+m,e)),r[n]=j,f(n=&quot;CRYPTO&quot;)&amp;&amp;(e===!!e||1===e||0===e?(V=!(!e||!a),e&amp;&amp;!V&amp;&amp;j&amp;&amp;L(2,&quot;crypto unavailable&quot;,a)):j&amp;&amp;L(2,n+m,e)),r[n]=V,f(n=&quot;MODULO_MODE&quot;)&amp;&amp;H(e,0,9,2,n)&amp;&amp;(W=0|e),r[n]=W,f(n=&quot;POW_PRECISION&quot;)&amp;&amp;H(e,0,A,2,n)&amp;&amp;(J=0|e),r[n]=J,f(n=&quot;FORMAT&quot;)&amp;&amp;(&quot;object&quot;==typeof e?X=e:j&amp;&amp;L(2,n+&quot; not an object&quot;,e)),r[n]=X,r},E.max=function(){return _(arguments,T.lt)},E.min=function(){return _(arguments,T.gt)},E.random=function(){var e=9007199254740992,n=Math.random()*e&amp;2097151?function(){return d(Math.random()*e)}:function(){return 8388608*(1073741824*Math.random()|0)+(8388608*Math.random()|0)};return function(e){var t,r,i,o,u,s=0,f=[],l=new E(q);if(e=null!=e&amp;&amp;H(e,0,A,14)?0|e:P,o=p(e/O),V)if(a&amp;&amp;a.getRandomValues){for(t=a.getRandomValues(new Uint32Array(o*=2));o&gt;s;)u=131072*t[s]+(t[s+1]&gt;&gt;&gt;11),u&gt;=9e15?(r=a.getRandomValues(new Uint32Array(2)),t[s]=r[0],t[s+1]=r[1]):(f.push(u%1e14),s+=2);s=o/2}else if(a&amp;&amp;a.randomBytes){for(t=a.randomBytes(o*=7);o&gt;s;)u=281474976710656*(31&amp;t[s])+1099511627776*t[s+1]+4294967296*t[s+2]+16777216*t[s+3]+(t[s+4]&lt;&lt;16)+(t[s+5]&lt;&lt;8)+t[s+6],u&gt;=9e15?a.randomBytes(7).copy(t,s):(f.push(u%1e14),s+=7);s=o/7}else j&amp;&amp;L(14,&quot;crypto unavailable&quot;,a);if(!s)for(;o&gt;s;)u=n(),9e15&gt;u&amp;&amp;(f[s++]=u%1e14);for(o=f[--s],e%=O,o&amp;&amp;e&amp;&amp;(u=S[O-e],f[s]=d(o/u)*u);0===f[s];f.pop(),s--);if(0&gt;s)f=[i=0];else{for(i=-1;0===f[0];f.shift(),i-=O);for(s=1,u=f[0];u&gt;=10;u/=10,s++);O&gt;s&amp;&amp;(i-=O-s)}return l.e=i,l.c=f,l}}(),C=function(){function e(e,n,t){var r,i,o,u,s=0,f=e.length,l=n%R,c=n/R|0;for(e=e.slice();f--;)o=e[f]%R,u=e[f]/R|0,r=c*o+u*l,i=l*o+r%R*R+s,s=(i/t|0)+(r/R|0)+c*u,e[f]=i%t;return s&amp;&amp;e.unshift(s),e}function n(e,n,t,r){var i,o;if(t!=r)o=t&gt;r?1:-1;else for(i=o=0;t&gt;i;i++)if(e[i]!=n[i]){o=e[i]&gt;n[i]?1:-1;break}return o}function r(e,n,t,r){for(var i=0;t--;)e[t]-=i,i=e[t]&lt;n[t]?1:0,e[t]=i*r+e[t]-n[t];for(;!e[0]&amp;&amp;e.length&gt;1;e.shift());}return function(i,o,u,s,f){var l,c,a,h,g,p,m,w,v,N,y,S,R,A,D,F,_,x=i.s==o.s?1:-1,I=i.c,L=o.c;if(!(I&amp;&amp;I[0]&amp;&amp;L&amp;&amp;L[0]))return new E(i.s&amp;&amp;o.s&amp;&amp;(I?!L||I[0]!=L[0]:L)?I&amp;&amp;0==I[0]||!L?0*x:x/0:NaN);for(w=new E(x),v=w.c=[],c=i.e-o.e,x=u+c+1,f||(f=b,c=t(i.e/O)-t(o.e/O),x=x/O|0),a=0;L[a]==(I[a]||0);a++);if(L[a]&gt;(I[a]||0)&amp;&amp;c--,0&gt;x)v.push(1),h=!0;else{for(A=I.length,F=L.length,a=0,x+=2,g=d(f/(L[0]+1)),g&gt;1&amp;&amp;(L=e(L,g,f),I=e(I,g,f),F=L.length,A=I.length),R=F,N=I.slice(0,F),y=N.length;F&gt;y;N[y++]=0);_=L.slice(),_.unshift(0),D=L[0],L[1]&gt;=f/2&amp;&amp;D++;do{if(g=0,l=n(L,N,F,y),0&gt;l){if(S=N[0],F!=y&amp;&amp;(S=S*f+(N[1]||0)),g=d(S/D),g&gt;1)for(g&gt;=f&amp;&amp;(g=f-1),p=e(L,g,f),m=p.length,y=N.length;1==n(p,N,m,y);)g--,r(p,m&gt;F?_:L,m,f),m=p.length,l=1;else 0==g&amp;&amp;(l=g=1),p=L.slice(),m=p.length;if(y&gt;m&amp;&amp;p.unshift(0),r(N,p,y,f),y=N.length,-1==l)for(;n(L,N,F,y)&lt;1;)g++,r(N,y&gt;F?_:L,y,f),y=N.length}else 0===l&amp;&amp;(g++,N=[0]);v[a++]=g,N[0]?N[y++]=I[R]||0:(N=[I[R]],y=1)}while((R++&lt;A||null!=N[0])&amp;&amp;x--);h=null!=N[0],v[0]||v.shift()}if(f==b){for(a=1,x=v[0];x&gt;=10;x/=10,a++);U(w,u+(w.e=a+c*O-1)+1,s,h)}else w.e=c,w.r=+h;return w}}(),h=function(){var e=/^(-?)0([xbo])(?=\w[\w.]*$)/i,n=/^([^.]+)\.$/,t=/^\.([^.]+)$/,r=/^-?(Infinity|NaN)$/,i=/^\s*\+(?=[\w.])|^\s+|\s+$/g;return function(o,u,s,f){var l,c=s?u:u.replace(i,&quot;&quot;);if(r.test(c))o.s=isNaN(c)?null:0&gt;c?-1:1;else{if(!s&amp;&amp;(c=c.replace(e,function(e,n,t){return l=&quot;x&quot;==(t=t.toLowerCase())?16:&quot;b&quot;==t?2:8,f&amp;&amp;f!=l?e:n}),f&amp;&amp;(l=f,c=c.replace(n,&quot;$1&quot;).replace(t,&quot;0.$1&quot;)),u!=c))return new E(c,l);j&amp;&amp;L(M,&quot;not a&quot;+(f?&quot; base &quot;+f:&quot;&quot;)+&quot; number&quot;,u),o.s=null}o.c=o.e=null,M=0}}(),T.absoluteValue=T.abs=function(){var e=new E(this);return e.s&lt;0&amp;&amp;(e.s=1),e},T.ceil=function(){return U(new E(this),this.e+1,2)},T.comparedTo=T.cmp=function(e,n){return M=1,i(this,new E(e,n))},T.decimalPlaces=T.dp=function(){var e,n,r=this.c;if(!r)return null;if(e=((n=r.length-1)-t(this.e/O))*O,n=r[n])for(;n%10==0;n/=10,e--);return 0&gt;e&amp;&amp;(e=0),e},T.dividedBy=T.div=function(e,n){return M=3,C(this,new E(e,n),P,k)},T.dividedToIntegerBy=T.divToInt=function(e,n){return M=4,C(this,new E(e,n),0,1)},T.equals=T.eq=function(e,n){return M=5,0===i(this,new E(e,n))},T.floor=function(){return U(new E(this),this.e+1,3)},T.greaterThan=T.gt=function(e,n){return M=6,i(this,new E(e,n))&gt;0},T.greaterThanOrEqualTo=T.gte=function(e,n){return M=7,1===(n=i(this,new E(e,n)))||0===n},T.isFinite=function(){return!!this.c},T.isInteger=T.isInt=function(){return!!this.c&amp;&amp;t(this.e/O)&gt;this.c.length-2},T.isNaN=function(){return!this.s},T.isNegative=T.isNeg=function(){return this.s&lt;0},T.isZero=function(){return!!this.c&amp;&amp;0==this.c[0]},T.lessThan=T.lt=function(e,n){return M=8,i(this,new E(e,n))&lt;0},T.lessThanOrEqualTo=T.lte=function(e,n){return M=9,-1===(n=i(this,new E(e,n)))||0===n},T.minus=T.sub=function(e,n){var r,i,o,u,s=this,f=s.s;if(M=10,e=new E(e,n),n=e.s,!f||!n)return new E(NaN);if(f!=n)return e.s=-n,s.plus(e);var l=s.e/O,c=e.e/O,a=s.c,h=e.c;if(!l||!c){if(!a||!h)return a?(e.s=-n,e):new E(h?s:NaN);if(!a[0]||!h[0])return h[0]?(e.s=-n,e):new E(a[0]?s:3==k?-0:0)}if(l=t(l),c=t(c),a=a.slice(),f=l-c){for((u=0&gt;f)?(f=-f,o=a):(c=l,o=h),o.reverse(),n=f;n--;o.push(0));o.reverse()}else for(i=(u=(f=a.length)&lt;(n=h.length))?f:n,f=n=0;i&gt;n;n++)if(a[n]!=h[n]){u=a[n]&lt;h[n];break}if(u&amp;&amp;(o=a,a=h,h=o,e.s=-e.s),n=(i=h.length)-(r=a.length),n&gt;0)for(;n--;a[r++]=0);for(n=b-1;i&gt;f;){if(a[--i]&lt;h[i]){for(r=i;r&amp;&amp;!a[--r];a[r]=n);--a[r],a[i]+=b}a[i]-=h[i]}for(;0==a[0];a.shift(),--c);return a[0]?I(e,a,c):(e.s=3==k?-1:1,e.c=[e.e=0],e)},T.modulo=T.mod=function(e,n){var t,r,i=this;return M=11,e=new E(e,n),!i.c||!e.s||e.c&amp;&amp;!e.c[0]?new E(NaN):!e.c||i.c&amp;&amp;!i.c[0]?new E(i):(9==W?(r=e.s,e.s=1,t=C(i,e,0,3),e.s=r,t.s*=r):t=C(i,e,0,W),i.minus(t.times(e)))},T.negated=T.neg=function(){var e=new E(this);return e.s=-e.s||null,e},T.plus=T.add=function(e,n){var r,i=this,o=i.s;if(M=12,e=new E(e,n),n=e.s,!o||!n)return new E(NaN);if(o!=n)return e.s=-n,i.minus(e);var u=i.e/O,s=e.e/O,f=i.c,l=e.c;if(!u||!s){if(!f||!l)return new E(o/0);if(!f[0]||!l[0])return l[0]?e:new E(f[0]?i:0*o)}if(u=t(u),s=t(s),f=f.slice(),o=u-s){for(o&gt;0?(s=u,r=l):(o=-o,r=f),r.reverse();o--;r.push(0));r.reverse()}for(o=f.length,n=l.length,0&gt;o-n&amp;&amp;(r=l,l=f,f=r,n=o),o=0;n;)o=(f[--n]=f[n]+l[n]+o)/b|0,f[n]%=b;return o&amp;&amp;(f.unshift(o),++s),I(e,f,s)},T.precision=T.sd=function(e){var n,t,r=this,i=r.c;if(null!=e&amp;&amp;e!==!!e&amp;&amp;1!==e&amp;&amp;0!==e&amp;&amp;(j&amp;&amp;L(13,&quot;argument&quot;+m,e),e!=!!e&amp;&amp;(e=null)),!i)return null;if(t=i.length-1,n=t*O+1,t=i[t]){for(;t%10==0;t/=10,n--);for(t=i[0];t&gt;=10;t/=10,n++);}return e&amp;&amp;r.e+1&gt;n&amp;&amp;(n=r.e+1),n},T.round=function(e,n){var t=new E(this);return(null==e||H(e,0,A,15))&amp;&amp;U(t,~~e+this.e+1,null!=n&amp;&amp;H(n,0,8,15,w)?0|n:k),t},T.shift=function(e){var n=this;return H(e,-y,y,16,&quot;argument&quot;)?n.times(&quot;1e&quot;+c(e)):new E(n.c&amp;&amp;n.c[0]&amp;&amp;(-y&gt;e||e&gt;y)?n.s*(0&gt;e?0:1/0):n)},T.squareRoot=T.sqrt=function(){var e,n,i,o,u,s=this,f=s.c,l=s.s,c=s.e,a=P+4,h=new E(&quot;0.5&quot;);if(1!==l||!f||!f[0])return new E(!l||0&gt;l&amp;&amp;(!f||f[0])?NaN:f?s:1/0);if(l=Math.sqrt(+s),0==l||l==1/0?(n=r(f),(n.length+c)%2==0&amp;&amp;(n+=&quot;0&quot;),l=Math.sqrt(n),c=t((c+1)/2)-(0&gt;c||c%2),l==1/0?n=&quot;1e&quot;+c:(n=l.toExponential(),n=n.slice(0,n.indexOf(&quot;e&quot;)+1)+c),i=new E(n)):i=new E(l+&quot;&quot;),i.c[0])for(c=i.e,l=c+a,3&gt;l&amp;&amp;(l=0);;)if(u=i,i=h.times(u.plus(C(s,u,a,1))),r(u.c).slice(0,l)===(n=r(i.c)).slice(0,l)){if(i.e&lt;c&amp;&amp;--l,n=n.slice(l-3,l+1),&quot;9999&quot;!=n&amp;&amp;(o||&quot;4999&quot;!=n)){(!+n||!+n.slice(1)&amp;&amp;&quot;5&quot;==n.charAt(0))&amp;&amp;(U(i,i.e+P+2,1),e=!i.times(i).eq(s));break}if(!o&amp;&amp;(U(u,u.e+P+2,0),u.times(u).eq(s))){i=u;break}a+=4,l+=4,o=1}return U(i,i.e+P+1,k,e)},T.times=T.mul=function(e,n){var r,i,o,u,s,f,l,c,a,h,g,p,d,m,w,v=this,N=v.c,y=(M=17,e=new E(e,n)).c;if(!(N&amp;&amp;y&amp;&amp;N[0]&amp;&amp;y[0]))return!v.s||!e.s||N&amp;&amp;!N[0]&amp;&amp;!y||y&amp;&amp;!y[0]&amp;&amp;!N?e.c=e.e=e.s=null:(e.s*=v.s,N&amp;&amp;y?(e.c=[0],e.e=0):e.c=e.e=null),e;for(i=t(v.e/O)+t(e.e/O),e.s*=v.s,l=N.length,h=y.length,h&gt;l&amp;&amp;(d=N,N=y,y=d,o=l,l=h,h=o),o=l+h,d=[];o--;d.push(0));for(m=b,w=R,o=h;--o&gt;=0;){for(r=0,g=y[o]%w,p=y[o]/w|0,s=l,u=o+s;u&gt;o;)c=N[--s]%w,a=N[s]/w|0,f=p*c+a*g,c=g*c+f%w*w+d[u]+r,r=(c/m|0)+(f/w|0)+p*a,d[u--]=c%m;d[u]=r}return r?++i:d.shift(),I(e,d,i)},T.toDigits=function(e,n){var t=new E(this);return e=null!=e&amp;&amp;H(e,1,A,18,&quot;precision&quot;)?0|e:null,n=null!=n&amp;&amp;H(n,0,8,18,w)?0|n:k,e?U(t,e,n):t},T.toExponential=function(e,n){return F(this,null!=e&amp;&amp;H(e,0,A,19)?~~e+1:null,n,19)},T.toFixed=function(e,n){return F(this,null!=e&amp;&amp;H(e,0,A,20)?~~e+this.e+1:null,n,20)},T.toFormat=function(e,n){var t=F(this,null!=e&amp;&amp;H(e,0,A,21)?~~e+this.e+1:null,n,21);if(this.c){var r,i=t.split(&quot;.&quot;),o=+X.groupSize,u=+X.secondaryGroupSize,s=X.groupSeparator,f=i[0],l=i[1],c=this.s&lt;0,a=c?f.slice(1):f,h=a.length;if(u&amp;&amp;(r=o,o=u,u=r,h-=r),o&gt;0&amp;&amp;h&gt;0){for(r=h%o||o,f=a.substr(0,r);h&gt;r;r+=o)f+=s+a.substr(r,o);u&gt;0&amp;&amp;(f+=s+a.slice(r)),c&amp;&amp;(f=&quot;-&quot;+f)}t=l?f+X.decimalSeparator+((u=+X.fractionGroupSize)?l.replace(new RegExp(&quot;\\d{&quot;+u+&quot;}\\B&quot;,&quot;g&quot;),&quot;$&amp;&quot;+X.fractionGroupSeparator):l):f}return t},T.toFraction=function(e){var n,t,i,o,u,s,f,l,c,a=j,h=this,g=h.c,p=new E(q),d=t=new E(q),m=f=new E(q);if(null!=e&amp;&amp;(j=!1,s=new E(e),j=a,(!(a=s.isInt())||s.lt(q))&amp;&amp;(j&amp;&amp;L(22,&quot;max denominator &quot;+(a?&quot;out of range&quot;:&quot;not an integer&quot;),e),e=!a&amp;&amp;s.c&amp;&amp;U(s,s.e+1,1).gte(q)?s:null)),!g)return h.toString();for(c=r(g),o=p.e=c.length-h.e-1,p.c[0]=S[(u=o%O)&lt;0?O+u:u],e=!e||s.cmp(p)&gt;0?o&gt;0?p:d:s,u=z,z=1/0,s=new E(c),f.c[0]=0;l=C(s,p,0,1),i=t.plus(l.times(m)),1!=i.cmp(e);)t=m,m=i,d=f.plus(l.times(i=d)),f=i,p=s.minus(l.times(i=p)),s=i;return i=C(e.minus(t),m,0,1),f=f.plus(i.times(d)),t=t.plus(i.times(m)),f.s=d.s=h.s,o*=2,n=C(d,m,o,k).minus(h).abs().cmp(C(f,t,o,k).minus(h).abs())&lt;1?[d.toString(),m.toString()]:[f.toString(),t.toString()],z=u,n},T.toNumber=function(){return+this},T.toPower=T.pow=function(e,n){var t,r,i,o=d(0&gt;e?-e:+e),u=this;if(null!=n&amp;&amp;(M=23,n=new E(n)),!H(e,-y,y,23,&quot;exponent&quot;)&amp;&amp;(!isFinite(e)||o&gt;y&amp;&amp;(e/=0)||parseFloat(e)!=e&amp;&amp;!(e=NaN))||0==e)return t=Math.pow(+u,e),new E(n?t%n:t);for(n?e&gt;1&amp;&amp;u.gt(q)&amp;&amp;u.isInt()&amp;&amp;n.gt(q)&amp;&amp;n.isInt()?u=u.mod(n):(i=n,n=null):J&amp;&amp;(t=p(J/O+2)),r=new E(q);;){if(o%2){if(r=r.times(u),!r.c)break;t?r.c.length&gt;t&amp;&amp;(r.c.length=t):n&amp;&amp;(r=r.mod(n))}if(o=d(o/2),!o)break;u=u.times(u),t?u.c&amp;&amp;u.c.length&gt;t&amp;&amp;(u.c.length=t):n&amp;&amp;(u=u.mod(n))}return n?r:(0&gt;e&amp;&amp;(r=q.div(r)),i?r.mod(i):t?U(r,J,k):r)},T.toPrecision=function(e,n){return F(this,null!=e&amp;&amp;H(e,1,A,24,&quot;precision&quot;)?0|e:null,n,24)},T.toString=function(e){var n,t=this,i=t.s,o=t.e;return null===o?i?(n=&quot;Infinity&quot;,0&gt;i&amp;&amp;(n=&quot;-&quot;+n)):n=&quot;NaN&quot;:(n=r(t.c),n=null!=e&amp;&amp;H(e,2,64,25,&quot;base&quot;)?D(l(n,o),0|e,10,i):B&gt;=o||o&gt;=$?f(n,o):l(n,o),0&gt;i&amp;&amp;t.c[0]&amp;&amp;(n=&quot;-&quot;+n)),n},T.truncated=T.trunc=function(){return U(new E(this),this.e+1,1)},T.valueOf=T.toJSON=function(){var e,n=this,t=n.e;return null===t?n.toString():(e=r(n.c),e=B&gt;=t||t&gt;=$?f(e,t):l(e,t),n.s&lt;0?&quot;-&quot;+e:e)},null!=e&amp;&amp;E.config(e),E}function t(e){var n=0|e;return e&gt;0||e===n?n:n-1}function r(e){for(var n,t,r=1,i=e.length,o=e[0]+&quot;&quot;;i&gt;r;){for(n=e[r++]+&quot;&quot;,t=O-n.length;t--;n=&quot;0&quot;+n);o+=n}for(i=o.length;48===o.charCodeAt(--i););return o.slice(0,i+1||1)}function i(e,n){var t,r,i=e.c,o=n.c,u=e.s,s=n.s,f=e.e,l=n.e;if(!u||!s)return null;if(t=i&amp;&amp;!i[0],r=o&amp;&amp;!o[0],t||r)return t?r?0:-s:u;if(u!=s)return u;if(t=0&gt;u,r=f==l,!i||!o)return r?0:!i^t?1:-1;if(!r)return f&gt;l^t?1:-1;for(s=(f=i.length)&lt;(l=o.length)?f:l,u=0;s&gt;u;u++)if(i[u]!=o[u])return i[u]&gt;o[u]^t?1:-1;return f==l?0:f&gt;l^t?1:-1}function o(e,n,t){return(e=c(e))&gt;=n&amp;&amp;t&gt;=e}function u(e){return&quot;[object Array]&quot;==Object.prototype.toString.call(e)}function s(e,n,t){for(var r,i,o=[0],u=0,s=e.length;s&gt;u;){for(i=o.length;i--;o[i]*=n);for(o[r=0]+=N.indexOf(e.charAt(u++));r&lt;o.length;r++)o[r]&gt;t-1&amp;&amp;(null==o[r+1]&amp;&amp;(o[r+1]=0),o[r+1]+=o[r]/t|0,o[r]%=t)}return o.reverse()}function f(e,n){return(e.length&gt;1?e.charAt(0)+&quot;.&quot;+e.slice(1):e)+(0&gt;n?&quot;e&quot;:&quot;e+&quot;)+n}function l(e,n){var t,r;if(0&gt;n){for(r=&quot;0.&quot;;++n;r+=&quot;0&quot;);e=r+e}else if(t=e.length,++n&gt;t){for(r=&quot;0&quot;,n-=t;--n;r+=&quot;0&quot;);e+=r}else t&gt;n&amp;&amp;(e=e.slice(0,n)+&quot;.&quot;+e.slice(n));return e}function c(e){return e=parseFloat(e),0&gt;e?p(e):d(e)}var a,h,g=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,p=Math.ceil,d=Math.floor,m=&quot; not a boolean or binary digit&quot;,w=&quot;rounding mode&quot;,v=&quot;number type has more than 15 significant digits&quot;,N=&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_&quot;,b=1e14,O=14,y=9007199254740991,S=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13],R=1e7,A=1e9;if(&quot;undefined&quot;!=typeof crypto&amp;&amp;(a=crypto),&quot;function&quot;==typeof define&amp;&amp;define.amd)define(function(){return n()});else if(&quot;undefined&quot;!=typeof module&amp;&amp;module.exports){if(module.exports=n(),!a)try{a=require(&quot;crypto&quot;)}catch(E){}}else e||(e=&quot;undefined&quot;!=typeof self?self:Function(&quot;return this&quot;)()),e.BigNumber=n()}(this);
  &lt;/script&gt;

  &lt;style&gt;
    body{
      font-family: &#39;HelveticaNeue-Light&#39;, &#39;Helvetica Neue Light&#39;, &#39;Helvetica Neue&#39;, &#39;Helvetica&#39;, &#39;Arial&#39;, &#39;Lucida Grande&#39;, sans-serif;
      background: #E2E2E2;
    }
    *, *:after, *:before {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    #pleasewait{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }
    #infomessage {
      text-align: center;
      font-size: 1rem;
      margin: 0 2rem 4.5rem;
    }

    .wrapper{
      background: #E2E2E2;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
      display:none;
      text-align: center;
    }
    .title {
      text-align: center;
      font-size: 1.2rem;
      margin: 1rem 0rem;
    }
    .message {
      text-align: center;
      font-size: 1rem;
      /*margin: 0 2rem 4.5rem;*/
    }

    #passwordField {
      text-align: center;
      font-size: 1rem;
      margin: 1rem 0rem;
      /*margin: 0 2rem 4.5rem;*/
    }

    .wrapper button {
      background: transparent;
      border: none;
      color: #1678E5;
      height: 3rem;
      font-size: 1rem;
      width: 50%;
      position: absolute;
      bottom: 0;
      cursor: pointer;
    }
    #cancel-button {
      border-top: 1px solid #B4B4B4;
      border-right: 1px solid #B4B4B4;
      left: 0;
      border-radius: 0 0 0 10px;
    }
    #confirm-button {
      border-top: 1px solid #B4B4B4;
      right: 0;
      border-radius: 0 0 10px 0;
    }
    .wrapper button:focus,
    .wrapper button:hover {
      font-weight: bold;
      background: #EFEFEF;
    }
    .wrapper button:active {
      background: #D6D6D6;
    }

    .button {
      margin: 1rem 0rem;
      display: inline-block;
      padding: 9px 15px;
      background-color: #3898EC;
      color: white;
      border: 0;
      line-height: inherit;
      text-decoration: none;
      cursor: pointer;
      border-radius: 0;
    }

    input.button {
      -webkit-appearance: button;
    }
  &lt;/style&gt;

  &lt;body&gt;

    &lt;div id=&quot;pleasewait&quot;&gt;
      &lt;br/&gt;
      &lt;p id=&quot;infomessage&quot;&gt;Please wait...&lt;/p&gt;
    &lt;/div&gt;

    &lt;form id=&quot;form&quot; class=&quot;wrapper&quot;&gt;
      &lt;br/&gt;
      &lt;p id=&quot;message&quot; class=&quot;message&quot;&gt;&lt;/p&gt;
      &lt;p id=&quot;passwordField&quot;&gt;&lt;label&gt;Password Required:&lt;/label&gt;&lt;input id=&quot;password&quot; type=&quot;password&quot; /&gt;&lt;/p&gt;
      &lt;button id=&quot;cancel-button&quot; type=&quot;button&quot; autofocus&gt;Cancel&lt;/button&gt;
      &lt;button id=&quot;confirm-button&quot; type=&quot;button&quot; &gt;Confirm&lt;/button&gt;
    &lt;/form&gt;

    &lt;div id=&quot;modal-dialog&quot; class=&quot;wrapper&quot;&gt;
      &lt;h3 id=&quot;modal-dialog-title&quot; class=&quot;title&quot;&gt;Title&lt;/h3&gt;
      &lt;p id=&quot;modal-dialog-message&quot; class=&quot;message&quot;&gt;Message&lt;/p&gt;
      &lt;span id=&quot;modal-dialog-button&quot; class=&quot;button&quot;&gt;Ok&lt;/span&gt;
    &lt;/div&gt;

    &lt;script&gt;
    var noMessageReceivedYet = true;
    var closedByCode = false;
    var pleaseWait = document.getElementById(&quot;pleasewait&quot;);
    var form = document.getElementById(&quot;form&quot;);
    var cancelButton = document.getElementById(&quot;cancel-button&quot;);
    var confirmButton = document.getElementById(&quot;confirm-button&quot;);
    var message = document.getElementById(&quot;message&quot;);
    var infoMessage = document.getElementById(&quot;infomessage&quot;);
    var password = document.getElementById(&quot;password&quot;);
    var passwordField = document.getElementById(&quot;passwordField&quot;);
    var modalDialog = document.getElementById(&quot;modal-dialog&quot;);
    var modalDialogButton = document.getElementById(&quot;modal-dialog-button&quot;);
    var modalDialogTitle = document.getElementById(&quot;modal-dialog-title&quot;);
    var modalDialogMessage = document.getElementById(&quot;modal-dialog-message&quot;);

    var firstUrl = null;

    var inIframe = true;
    var source = null;
    if(window.opener){
      inIframe = false;
      source = window.opener;
    }else if(window.parent != window){
      source = window.parent;
    }else{
      console.log(&quot;closing&quot;);
      window.close();
    }

    function closeWindow(){
      closedByCode = true;
      window.close();
    }

    function showWaiting(text){
      if(!text){
        text = &quot;Please wait...&quot;
      }
      infoMessage.innerHTML = text;
      pleaseWait.style.display = &quot;block&quot;;
      form.style.display = &quot;none&quot;;
    }

    function hideWaiting(){
      pleaseWait.style.display = &quot;none&quot;;
      form.style.display = &quot;block&quot;;

      window.onbeforeunload = null;
    }

    function showMessage(title, message, callback, buttonText){
      modalDialog.style.display = &quot;block&quot;;
      modalDialogTitle.innerHTML = title;
      modalDialogMessage.innerHTML = &quot;&quot;;
      if((typeof message) == &quot;string&quot;){
        modalDialogMessage.innerHTML += message;
      }else{
        modalDialogMessage.appendChild(message);
      }
      modalDialogMessage.appendChild(document.createElement(&#39;br&#39;));

      if(!buttonText){
        buttonText = &quot;Ok&quot;;
      }
      modalDialogButton.innerHTML = buttonText;
      modalDialogButton.onclick = function(){
        modalDialogButton.onclick = null;
        modalDialog.style.display = &quot;none&quot;;
        if(callback){
          callback();
        }
      }
    }

    function hideMessage(){
      modalDialog.style.display = &quot;none&quot;;
      modalDialogButton.onclick = null;
    }

    function sendAsync(url,payload, callback) {
      var request = new XMLHttpRequest();
      request.open(&#39;POST&#39;, url, true);
      request.setRequestHeader(&#39;Content-Type&#39;,&#39;application/json&#39;);

      request.onreadystatechange = function() {
        if (request.readyState === 4) {
          var result = request.responseText;
          var error = null;
          try {
            result = JSON.parse(result);
          } catch(e) {
            var message = !!result &amp;&amp; !!result.error &amp;&amp; !!result.error.message ? result.error.message : &#39;Invalid JSON RPC response: &#39; + JSON.stringify(result);
            error = {message:message,type:&quot;JsonParse&quot;};
          }
          callback(error, result);
        }
      };

      try {
        request.send(JSON.stringify(payload));
      } catch(e) {
        callback({message:&#39;CONNECTION ERROR: Couldn\&#39;t connect to node &#39;+ url +&#39;.&#39;,type:&quot;noConnection&quot;});
      }
    }

    function addBlocky(message, address){
      var icon = blockies.create({
        seed: address,
        size: 8,
        scale: 6
      });
      message.appendChild(icon);
    }

    function askAuthorization(transactionInfo, data, requireUnlock, sourceWindow){


      var value = transactionInfo[&quot;value&quot;] ? transactionInfo.value : &quot;0&quot;;
      var gasProvided = transactionInfo.gas;
      var gasPriceProvided = transactionInfo.gasPrice;
      var gasPrice = new BigNumber(gasPriceProvided,16);
      var gas = new BigNumber(gasProvided,16);
      var weiValue = new BigNumber(value,16);
      var gasWeiValue = gas.times(gasPrice);
      var etherValue = weiValue.dividedBy(new BigNumber(&quot;1000000000000000000&quot;));
      var gasEtherValue = gasWeiValue.dividedBy(new BigNumber(&quot;1000000000000000000&quot;));

      hideWaiting();

      message.innerHTML = &quot;&quot;;

      addBlocky(message,transactionInfo.from);

      var span = document.createElement(&#39;span&#39;);
      span.style=&quot;font-size:3em;&quot;;
      span.innerHTML = &quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot; + &quot;&amp;#x2192;&quot; + &quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;;
      message.appendChild(span);

      addBlocky(message,transactionInfo.to);

      message.appendChild(document.createElement(&#39;br&#39;));
      var textSpan = document.createElement(&quot;span&quot;);
      message.appendChild(textSpan);
      textSpan.innerHTML = etherValue.toFormat() + &quot; ether &lt;br/&gt;  + gas cost (&quot; + gasEtherValue.toFormat() + &quot; ether )&quot;

      if(requireUnlock){
        passwordField.style.display = &quot;block&quot;;
      }else{
        passwordField.style.display = &quot;none&quot;;
      }

      cancelButton.onclick = function(){
        sourceWindow.postMessage({id:data.id,result:null,error:{message:&quot;Not Authorized&quot;},type:&quot;cancel&quot;},firstUrl);
        closeWindow();
      }

      var submitFunc = function(){
        window.onbeforeunload = function (event) {
          if(!closedByCode){
            return &quot;do not close now as a transaction is progress, this cannot be canceled and we wait for an answer&quot;;
          }
        };
        if(requireUnlock){
          if(password.value == &quot;&quot;){
            password.style.border = &quot;2px solid red&quot;;
            return false;
          }
          password.style.border = &quot;none&quot;;
          var params = [transactionInfo.from,password.value,3];
          showWaiting(&quot;Please wait...&lt;br/&gt;Do not close the window.&quot;);
          sendAsync(data.url,{id:999992,method:&quot;personal_unlockAccount&quot;,params:params},function(error,result){
            if(error || result.error){
              showMessage(&quot;Error unlocking account&quot;, &quot;Please retry.&quot;, hideWaiting);
            }else{
              sendAsync(data.url,data.payload,function(error,result){
                sourceWindow.postMessage({id:data.id,result:result,error:error},firstUrl);
                closeWindow();
              });
            }
          });
        }else{
          sendAsync(data.url,data.payload,function(error,result){
            if(result &amp;&amp; result.error){
              processMessage(data,sourceWindow);
            }else{
              sourceWindow.postMessage({id:data.id,result:result,error:error},firstUrl);
              closeWindow();
            }
          });
          showWaiting();
        }
        return false;
      }

      form.onsubmit = submitFunc;
      confirmButton.onclick = submitFunc;
    }

    function needToAndCanUnlockAccount(address,url,callback){
      sendAsync(url,{id:9999990,method:&quot;eth_sign&quot;,params:[address,&quot;0xc6888fa8d57087278718986382264244252f8d57087278718986382264244252f&quot;]},function(error,result){
        if(error || result.error){
          sendAsync(url,{id:9999991,method:&quot;personal_listAccounts&quot;,params:[]},function(error,result){
            if(error || result.error){
              callback(true,false);
            }else{
              callback(true,true);
            }
          });
        }else{
          callback(false);
        }
      });
    }

    function receiveMessage(event){
      if(event.source != source){
        return;
      }
      if(firstUrl){
        if(firstUrl != event.origin){
          return;
        }
      }else{
        firstUrl = event.origin;
      }
      hideMessage();
      noMessageReceivedYet = false;
      var data = event.data;
      try{
        processMessage(data,event.source);
      }catch(e){
        event.source.postMessage({id:data.id,result:null,error:{message:&quot;Could not process message data&quot;},type:&quot;notValid&quot;},firstUrl);
        showMessage(&quot;Error&quot;,&quot;The application has sent invalid data&quot;, function(){
          closeWindow();
        });
      }

    }

    var allowedMethods = [
       &quot;web3_clientVersion&quot;
      ,&quot;web3_sha3&quot;
      ,&quot;net_version&quot;
      ,&quot;net_peerCount&quot;
      ,&quot;net_listening&quot;
      ,&quot;eth_protocolVersion&quot;
      ,&quot;eth_syncing&quot;
      ,&quot;eth_coinbase&quot;
      ,&quot;eth_mining&quot;
      ,&quot;eth_hashrate&quot;
      ,&quot;eth_gasPrice&quot;
      ,&quot;eth_accounts&quot;
      ,&quot;eth_blockNumber&quot;
      ,&quot;eth_getBalance&quot;
      ,&quot;eth_getStorageAt&quot;
      ,&quot;eth_getTransactionCount&quot;
      ,&quot;eth_getBlockTransactionCountByHash&quot;
      ,&quot;eth_getBlockTransactionCountByNumber&quot;
      ,&quot;eth_getUncleCountByBlockHash&quot;
      ,&quot;eth_getUncleCountByBlockNumber&quot;
      ,&quot;eth_getCode&quot;
      ,&quot;eth_sendRawTransaction&quot;
      ,&quot;eth_call&quot;
      ,&quot;eth_estimateGas&quot;
      ,&quot;eth_getBlockByHash&quot;
      ,&quot;eth_getBlockByNumber&quot;
      ,&quot;eth_getTransactionByHash&quot;
      ,&quot;eth_getTransactionByBlockHashAndIndex&quot;
      ,&quot;eth_getTransactionByBlockNumberAndIndex&quot;
      ,&quot;eth_getTransactionReceipt&quot;
      ,&quot;eth_getUncleByBlockHashAndIndex&quot;
      ,&quot;eth_getUncleByBlockNumberAndIndex&quot;
      ,&quot;eth_getCompilers&quot;
      ,&quot;eth_compileLLL&quot;
      ,&quot;eth_compileSolidity&quot;
      ,&quot;eth_compileSerpent&quot;
      ,&quot;eth_newFilter&quot;
      ,&quot;eth_newBlockFilter&quot;
      ,&quot;eth_newPendingTransactionFilter&quot;
      ,&quot;eth_uninstallFilter&quot;
      ,&quot;eth_getFilterChanges&quot;
      ,&quot;eth_getFilterLogs&quot;
      ,&quot;eth_getLogs&quot;
      ,&quot;eth_getWork&quot;
      ,&quot;eth_submitWork&quot;
      ,&quot;eth_submitHashrate&quot;
      // ,&quot;shh_post&quot;
      // ,&quot;shh_version&quot;
      // ,&quot;shh_newIdentity&quot;
      // ,&quot;shh_hasIdentity&quot;
      // ,&quot;shh_newGroup&quot;
      // ,&quot;shh_addToGroup&quot;
      // ,&quot;shh_newFilter&quot;
      // ,&quot;shh_uninstallFilter&quot;
      // ,&quot;shh_getFilterChanges&quot;
      // ,&quot;shh_getMessages&quot;
    ];

    function isMethodAllowed(method){
      return allowedMethods.indexOf(method) != -1;
    }

    function processMessage(data, sourceWindow){

      if(inIframe){
        if(isMethodAllowed(data.payload.method)){
          sendAsync(data.url,data.payload,function(error,result){
            sourceWindow.postMessage({id:data.id,result:result,error:error},firstUrl);
          });
        }else{
          sourceWindow.postMessage({id:data.id,result:null,error:{message:&quot;method (&quot; + data.payload.method + &quot;) not allowed in iframe&quot;},type:&quot;notAllowed&quot;},firstUrl);
        }
      }else if(data.payload.method == &quot;eth_sendTransaction&quot;){
        var transactionInfo = null;
        if(data.payload.params.length &gt; 0){
          if(data.payload.params[0][&quot;gas&quot;] &amp;&amp; data.payload.params[0][&quot;gasPrice&quot;] &amp;&amp; data.payload.params[0][&quot;to&quot;] &amp;&amp; data.payload.params[0][&quot;from&quot;]){
            transactionInfo = data.payload.params[0];
          }
        }
        if(transactionInfo != null){
          needToAndCanUnlockAccount(transactionInfo.from,data.url,function(requireUnlock,canUnlock){
            if(requireUnlock &amp;&amp; canUnlock){
              askAuthorization(transactionInfo,data,true, sourceWindow);
            }else if(!requireUnlock){
              askAuthorization(transactionInfo,data,false,sourceWindow);
            }else if(requireUnlock &amp;&amp; !canUnlock){
              var messageHtml = document.createElement(&#39;span&#39;);
              addBlocky(messageHtml,transactionInfo.from);
              messageHtml.appendChild(document.createElement(&#39;br&#39;));
              var span = document.createElement(&#39;span&#39;);
              span.innerHTML = &quot;You need to unlock your account first : &lt;br/&gt;&quot; + transactionInfo.from;
              messageHtml.appendChild(span);

              showMessage(&quot;Account Locked&quot;,messageHtml,function(){
                processMessage(data,sourceWindow);
              }, &quot;Done&quot;);
            }

          });
        }else{
          sourceWindow.postMessage({id:data.id,result:null,error:{message:&quot;Need to specify from , to, gas and gasPrice&quot;},type:&quot;notValid&quot;},firstUrl);
          closeWindow();
        }
      }else{
        sourceWindow.postMessage({id:data.id,result:null,error:{message:&quot;method (&quot; + data.payload.method + &quot;) not allowed in popup&quot;},type:&quot;notAllowed&quot;},firstUrl);
      }     
    }

    function checkMessageNotReceived(){
      if(noMessageReceivedYet){
        showMessage(&quot;Error&quot;,&quot;No transaction received. Please make sure popup are not blocked.&quot;, function(){
          closeWindow();
        });
      }
    }
    setTimeout(checkMessageNotReceived,1000);

    window.addEventListener(&quot;message&quot;, receiveMessage);
    if(source){
      source.postMessage(&quot;ready&quot;,&quot;*&quot;);
    }

    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</span></code></pre><h2 id="copyright">Copyright</h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>



            </div>
        </main>


        <footer class="site-footer h-card">
            <div class="wrapper">
                <h2 class="footer-heading">Ethereum Improvement Proposals</h2>
                <div class="footer-col-wrapper">
                    <div class="footer-col footer-col-1">
                        <ul class="contact-list">
                            <li class="p-name">
                                
                                GitHub User
                                
                            </li>
                            <li>
                                <a class="u-email" href="mailto:your-email@domain.com">
                                  your-email@domain.com
                                </a>
                              </li>
                            </ul>
                    </div>
                    <div class="footer-col footer-col-3">
                        <p>Description</p>
                    </div>
                </div>
            </div>
        </footer>
    </body>
</html>
